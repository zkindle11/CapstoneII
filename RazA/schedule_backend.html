<?php 
include "authenticate.html";
include("connectDatabase.html");

$classes = array();

if(isset($_SESSION['classes'])){
    $classes = $_SESSION['classes'];
}

if($_POST['add_class'] === 'Add Class'){
    add_class();
    print_class_list();
}

if($_POST['print_calendar'] === 'Print Calendar'){
//    print_r($_POST);
    add_to_calendar();
}

if($_POST['get_classes'] === 'Get Classes'){
    search_classes();
    print_search_results();
}

if($_POST['clear_queue'] === 'Clear Queue'){
    $classes = array();
    clear_queue();
}

if($_POST['remove_class'] === 'Remove Class'){
    remove_class();
    print_class_list();
}

if($_POST['print_queue'] === 'Print Queue') {
    print_class_list();
}
    
function add_class() {   
    global $classes;
    $x = 0;
    foreach ($classes as $check){
        if($check[0] === strtoupper($_POST['dept']) && $check[1] === $_POST['class_number']){
            $x = 1;
        }
    }
    
    if($x === 0){
        array_push($classes, array(strtoupper($_POST['dept']),$_POST['class_number']));
    }
    
    $_SESSION['classes'] = $classes;
}

function print_class_list() {
    global $classes;
    $formStr = '';
    $elementStr = '';
    $x = 0;
    
    if(isset($_SESSION['classes'])) {
        foreach ($classes as $formElement) {
            $elementStr = '<input type="checkbox" name="' .
                $x . '" value = "' . $x . '">' . $formElement['0'] . 
                ' ' .  $formElement['1'] . '<br />';       
            $x++;       
            $formStr .= $elementStr;
        }
    }
    echo $formStr;
}

function search_classes(){
    global $dbh;
    global $classes;
    $numOfClasses = count($classes);
    $x = 0;
    $results = array();
    
    while($x < $numOfClasses) {
        $query = "SELECT * FROM classes WHERE Dept = '" . $classes[$x][0] . "' and CourseNum = '" . $classes[$x][1] . "'";
        $results[$x] = $dbh->query($query)->fetchALL(PDO::FETCH_ASSOC);    
        $x++;
    }

    $dbh = null;
    
    $_SESSION['classList'] = $results;  
}

function print_search_results() {
    $classes = $_SESSION['classList'];
    $x = 1;
    $y = 0;
    $str = '';
    $str .= '<fieldset style="width:700px"><legend>Search Results:</legend>'
          .'<div id="tabs">';
    
    foreach ($classes as $classList) {
        $str .= '<h3>' . $classList[0]['Title'] . '</h3> <div> ';
        foreach($classList as $results) {           
            $str .= '<p>' . '<input type="checkbox" name="' . $x . $y . '" value = "' . $x .$y  . '" onclick="test()">' . 
                  $results['Component']. ' <b>' . $results['StartTime'] . '-' . $results['EndTime'].'</b>';
            if($results['Mon'] == 1){
                $str .= ' Mon';
            }
            if($results['Tue'] == 1) {
                $str .= ' Tues';
            }
            if($results['Wed'] == 1) {
                    $str .= ' Wed';
            }
            if($results['Thu'] == 1) {
                    $str .= ' Thu';
            }
            if($results['Fri'] == 1) {
                    $str .= ' Fri';
            }
            $str .= '</p>';
            $y++;
        }
        $str .= '</div>';
        $x++;
    }
    $str .= '</div></fieldset>';
    echo $str;
}

 function clear_queue() {
     $_SESSION['classes'] = array();
     $_SESSION['classList'] = array();
     echo 'queue cleared!';
 }
 
 function remove_class() {
     global $classes;
     $x = 0;
     $cap = count($classes);

     while($x < $cap) {         
         if(isset($_POST[$x])){
             unset($classes[$x]);
         }
         $x++;
     }
     
     $_SESSION['classes'] = array_values($classes);
 }
 
function add_to_calendar() {
    $courses = $_SESSION['classList'];
    $x = 1;
    $y = 0;
    $payload = '';
    $calendarId = array();
    
    foreach($courses as $course) {
        foreach($course as $sections){
            if(isset($_POST[$x.$y])){
                if($sections['Mon'] == 1){
                    $start_time = str_split($sections['StartTime']);
                    $end_time = str_split($sections['EndTime']);
                    $payload .= '{&quot;id&quot;:'.$x.$y.'1'.','
                   .'&quot;start&quot;: new Date(year, month, day-1,'.$start_time[0].$start_time[1]. ','. $start_time[3].$start_time[4].'),'
                   .'&quot;end&quot;: new Date(year, month, day-1,'.$end_time[0].$end_time[1]. ','. $end_time[3].$end_time[4].'),'
                   .'&quot;title&quot;:&quot;' . $sections['Dept'].' '.$sections['CourseNum'] . '&quot;,'
                   .'readOnly : true'
                   .'},';
                }
                if($sections['Tue'] == 1) {
                    $start_time = str_split($sections['StartTime']);
                    $end_time = str_split($sections['EndTime']);
                    $payload .= '{&quot;id&quot;:'.$x.$y.'2'.','
                   .'&quot;start&quot;: new Date(year, month, day,'.$start_time[0].$start_time[1]. ','. $start_time[3].$start_time[4].'),'
                   .'&quot;end&quot;: new Date(year, month, day,'.$end_time[0].$end_time[1]. ','. $end_time[3].$end_time[4].'),'
                   .'&quot;title&quot;:&quot;' . $sections['Dept'].' '.$sections['CourseNum'] . '&quot;,'
                   .'readOnly : true'
                   .'},';
                }
                if($sections['Wed'] == 1) {
                    $start_time = str_split($sections['StartTime']);
                    $end_time = str_split($sections['EndTime']);
                    $payload .= '{&quot;id&quot;:'.$x.$y.'3'.','
                   .'&quot;start&quot;: new Date(year, month, day+1,'.$start_time[0].$start_time[1]. ','. $start_time[3].$start_time[4].'),'
                   .'&quot;end&quot;: new Date(year, month, day+1,'.$end_time[0].$end_time[1]. ','. $end_time[3].$end_time[4].'),'
                   .'&quot;title&quot;:&quot;' . $sections['Dept'].' '.$sections['CourseNum'] . '&quot;,'
                   .'readOnly : true'
                   .'},';
                }
                if($sections['Thu'] == 1) {
                    $start_time = str_split($sections['StartTime']);
                    $end_time = str_split($sections['EndTime']);
                    $payload .= '{&quot;id&quot;:'.$x.$y.'4'.','
                   .'&quot;start&quot;: new Date(year, month, day+2,'.$start_time[0].$start_time[1]. ','. $start_time[3].$start_time[4].'),'
                   .'&quot;end&quot;: new Date(year, month, day+2,'.$end_time[0].$end_time[1]. ','. $end_time[3].$end_time[4].'),'
                   .'&quot;title&quot;:&quot;' . $sections['Dept'].' '.$sections['CourseNum'] . '&quot;,'
                   .'readOnly : true'
                   .'},';
                }
                if($sections['Fri'] == 1) {
                    $start_time = str_split($sections['StartTime']);
                    $end_time = str_split($sections['EndTime']);
                    $payload .= '{&quot;id&quot;:'.$x.$y.'5'.','
                   .'&quot;start&quot;: new Date(year, month, day+3,'.$start_time[0].$start_time[1]. ','. $start_time[3].$start_time[4].'),'
                   .'&quot;end&quot;: new Date(year, month, day+3,'.$end_time[0].$end_time[1]. ','. $end_time[3].$end_time[4].'),'
                   .'&quot;title&quot;:&quot;' . $sections['Dept'].' '.$sections['CourseNum'] . '&quot;,'
                   .'readOnly : true'
                   .'},';
                }
            }
            $y++;
        }
        $x++;
    }
    
    echo $payload;
}
?>